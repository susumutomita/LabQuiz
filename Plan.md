# Plan.md — https://github.com/o-shina/scrum-guardこれと同じ仕組みで細胞培養の基本やラボルール会社の仕組みを楽しく覚えてテストできる仕組みを作りたい

> Execution plan for AI coding agents. Update this file as you make progress.
> Generated by [DeepForm](https://deepform.exe.xyz)

## Purpose

バイオ系ラボにおいて、新人スタッフ（月1人以上入社）への教育がOJT中心で1人あたり1ヶ月以上かかり、口頭伝達による抜け漏れ・属人化が常態化している。特にゾーニング（汚染エリア区分）は暗黙知化しており体系的に教えられない。結果としてコンタミが数ヶ月に1回発生し、先輩社員の教育工数が継続的に浪費されている。scrum-guard のようなクイズ形式の反復学習システムで、細胞培養手順・ラボルール・安全管理を構造化し、新人が自律的に学習・テストできる仕組みを構築する。

**Target User**: バイオ系中規模ラボ（10〜30人）の新人スタッフ（入社直後〜3ヶ月目）、教育担当の先輩研究員、クイズ内容をレビューする専門家（研究責任者等）、学習進捗を把握するラボマネージャー

## Jobs to be Done

1. 新人として：細胞培養手順・ゾーニング・試薬安全管理・報告ルートを、反復クイズで自分のペースで確実に覚えたい
2. 先輩研究員として：同じ説明を何度も繰り返さず、新人の理解度を客観的に把握して不足箇所だけ補足したい
3. 専門家として：クイズ内容を10分以内で効率的にレビューし、誤情報の配信を防ぎたい
4. ラボマネージャーとして：新人ごとの学習進捗とテスト結果を一覧で確認し、OJT期間を短縮したい

## Implementation Tasks

### 1. カテゴリ別クイズ出題・回答エンジン [must]

  - [ ] DBに登録されたクイズ問題がカテゴリ別にランダム抽出され、ブラウザに表示される
  - [ ] 回答送信後、正誤判定と解説がDBから取得・表示される
  - [ ] 1セッションのスコア（正答数/出題数）がDBに保存される
  - [ ] 満点達成時にバッジがユーザーレコードに付与される
  - [ ] データ経路はすべて実DBを使用し、モックデータやハードコード配列は不可

### 2. クイズ問題管理・AI生成＋専門家レビュー [must]

  - [ ] マニュアルファイル（PDF/TXT）アップロード後、AI APIを呼び出しクイズ候補がDBに保存される
  - [ ] レビュー画面で問題文・選択肢・正答・解説が一覧表示され、承認/修正/却下操作ができる
  - [ ] 承認ステータスが「承認済」の問題のみが出題エンジンから取得される
  - [ ] 10問のレビューが10分以内で完了できるUI（1問あたり60秒以内で判断可能な情報量）
  - [ ] データ経路は実DB・実AI API接続であること

### 3. ゾーニング視覚化クイズ [must]

  - [ ] 管理者がラボ平面図画像をアップロードし、クリックでエリアを矩形指定・ゾーン属性（清潔/準清潔/一般）を付与できる
  - [ ] 出題時にエリアがハイライトされ、そのエリアのルールに関する問題が表示される
  - [ ] ゾーンデータ・エリア座標・属性はすべてDBに保存される
  - [ ] データ経路が実DBであること

### 4. 学習進捗ダッシュボード [must]

  - [ ] ユーザー一覧にカテゴリ別正答率・受験回数・最終受験日が表示される
  - [ ] 正答率が70%未満のカテゴリが「要注意」としてハイライトされる
  - [ ] データはDBのクイズ回答履歴から集計される（リアルタイム）
  - [ ] CSV形式でのエクスポートが可能
  - [ ] データ経路が実DBであること

### 5. ユーザー・ロール管理 [must]

  - [ ] 管理者がユーザーを登録し、4種のロール（learner/creator/reviewer/admin）を付与できる
  - [ ] ロールに応じてアクセス可能な画面・APIが制限される
  - [ ] 認証はメールアドレス＋パスワードで実施、セッション管理はサーバーサイド
  - [ ] ユーザーデータは実DBに保存されること

## Technical Setup

```
# LabQuiz — Implementation Spec

## Tech Stack
- Frontend: React + TypeScript + Vite + TailwindCSS
- Backend: Node.js + Hono + TypeScript
- Database: PostgreSQL
- Storage: S3互換ストレージ（MinIO or AWS S3）
- Auth: JWT（サーバーサイドセッション管理）
- AI: OpenAI API（GPT-4）
- Infra: Docker Compose

## API Endpoints (top 5 only)
| Method | Path | Description |
|--------|------|-------------|
| POST | /api/auth/login | メール+パスワードで認証しJWTを返す |
| GET | /api/quizzes | カテゴリ・件数指定で承認済みクイズをランダム取得 |
| POST | /api/quizzes/:quizId/answer | 回答を送信し正誤・解説・スコアを返す |
| POST | /api/quizzes/generate | マニュアルPDFをアップロードしAIでクイズ候補生成 |
| PUT | /api/quizzes/:quizId/review | 専門家がクイズを承認/修正/却下 |

## Database Schema
sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  role TEXT NOT NULL, -- learner/creator/reviewer/admin
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE quizzes (
  id UUID PRIMARY KEY,
  category_id UUID NOT NULL,
  question TEXT NOT NULL,
  choices JSONB NOT NULL, -- [{id, text}]
  correct_choice_id TEXT NOT NULL,
  explanation TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending', -- pending/approved/rejected
  created_by UUID NOT NULL,
  reviewed_by UUID,
  floor_plan_zone_id UUID,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE quiz_answers (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  quiz_id UUID NOT NULL,
  session_id UUID NOT NULL,
  choice_id TEXT NOT NULL,
  is_correct BOOLEAN NOT NULL,
  answered_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE floor_plans (
  id UUID PRIMARY KEY,
  image_url TEXT NOT NULL,
  zones JSONB NOT NULL, -- [{zoneId, label, rect:{x,y,w,h}, type}]
  created_by UUID NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE categories (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT
);

CREATE TABLE badges (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  category_id UUID NOT NULL,
  earned_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);


## Screens (max 4)
| Screen | Path | Description |
|--------|------|-------------|
| ログイン | /login | メール+パスワード認証、ロール別リダイレクト |
| クイズ画面 | /quiz | カテゴリ選択→4択出題→即時正誤・解説表示→スコア確認 |
| レビュー画面 | /review | AI生成クイズ一覧の承認/修正/却下操作（reviewer/admin） |
| ダッシュボード | /dashboard | 全ユーザーのカテゴリ別正答率・弱点・受験回数一覧（admin） |

## Key Test Cases (max 5)
| Test | Given | When | Then |
|------|-------|------|------|
| 承認済みのみ出題 | 承認済み3件・未承認2件がDBにある | GET /api/quizzes?category=X | 承認済み3件のみ返却される |
| 正答でスコア保存 | 認証済みユーザー、正しいchoiceIdを送信 | POST /api/quizzes/:id/answer | is_correct=true、quiz_answersにレコード挿入される |
| 満点時バッジ付与 | 10問セッションで全問正解 | セッション終了API呼び出し | badgesテーブルに該当カテゴリのバッジが挿入される |
| 権限外アクセス拒否 | learnerロールのJWT | PUT /api/quizzes/:id/review | 403レスポンスが返る |
| カテゴリ0件エラー | 指定カテゴリに承認済み問題が0件 | GET /api/quizzes?category=empty | 空配列+メッセージを返す（200） |

## Implementation Constraints
- Real DB/API connections only. No mock data, no hardcoded arrays.
- Backend-first: implement API before UI.
- Show "Not implemented" for unfinished features.
- All API endpoints must be callable by external services (API-first design).
- パスワードはbcryptでハッシュ化必須。
- ファイルアップロードはS3互換ストレージに保存し、DBにはURLのみ保存。
- AI生成はOpenAI APIへの実接続のみ（モック不可）；障害時は既存クイズ出題は継続。
- DBスキーマ変更はマイグレーションファイル（db/migrations/）で管理。
- Docker Composeでapp・db・storageの3サービスを起動可能にする。
- 楽観的ロック：quizzesテーブルにupdated_atを用いて同時レビュー競合を検出し409を返す。

```

## Validation — User Flows

### 新人のクイズ学習フロー
1. ログイン
2. カテゴリ一覧から学習したいカテゴリを選択
3. クイズ開始（10問1セット）
4. 各問題に回答し、即時に正誤・解説を確認
5. セッション終了後にスコアとバッジを確認
6. 弱点カテゴリを再受験

### AI問題生成＋専門家レビューフロー
1. 先輩研究員がマニュアルPDFをアップロード
2. カテゴリとAI生成問題数を指定して生成実行
3. AI生成されたクイズ候補一覧が表示される
4. 専門家がレビュー画面で各問題を承認/修正/却下
5. 承認された問題が出題プールに追加される

### ラボマネージャーの進捗確認フロー
1. ログイン
2. ダッシュボードでユーザー一覧と進捗を確認
3. 要注意カテゴリのある新人を特定
4. 該当新人の詳細画面で回答履歴を確認
5. 必要に応じてOJT補足指示を行う

## Progress Log

<!-- Update this section as you implement features -->

| Date | What was done | Status |
|------|---------------|--------|
| — | Project initialized with DeepForm | Done |
| 2026-02-22 | Docker Compose + DB migration + seed 実装 | Done |
| 2026-02-22 | Backend API 全エンドポイント実装（auth, quizzes, users, dashboard, generate, floorPlans） | Done |
| 2026-02-22 | Frontend 全画面実装（Login, Quiz, Review, Dashboard） | Done |
| 2026-02-22 | 全画面の動作確認完了（ブラウザテスト） | Done |
| 2026-02-23 | GAS Web App 化: サーバー側 (src/) 全実装、フロントエンド GAS 対応、ビルド設定変更 | Done |

## Notes

- Follow AGENT.md for development rules and conventions
- Check off tasks as you complete them
- Add notes about decisions and blockers in this section
- ポート: DB=5435, Backend=3004, Frontend=5175（既存プロジェクトとの競合回避）
- 管理者アカウント: ADMIN_EMAIL / ADMIN_PASSWORD 環境変数で設定
