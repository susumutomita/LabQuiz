{
  "spec": {
    "raw": "# LabQuiz — Implementation Spec\n\n## Tech Stack\n- Frontend: React + TypeScript + Vite + TailwindCSS\n- Backend: Node.js + Hono + TypeScript\n- Database: PostgreSQL\n- Storage: S3互換ストレージ（MinIO or AWS S3）\n- Auth: JWT（サーバーサイドセッション管理）\n- AI: OpenAI API（GPT-4）\n- Infra: Docker Compose\n\n## API Endpoints (top 5 only)\n| Method | Path | Description |\n|--------|------|-------------|\n| POST | /api/auth/login | メール+パスワードで認証しJWTを返す |\n| GET | /api/quizzes | カテゴリ・件数指定で承認済みクイズをランダム取得 |\n| POST | /api/quizzes/:quizId/answer | 回答を送信し正誤・解説・スコアを返す |\n| POST | /api/quizzes/generate | マニュアルPDFをアップロードしAIでクイズ候補生成 |\n| PUT | /api/quizzes/:quizId/review | 専門家がクイズを承認/修正/却下 |\n\n## Database Schema\nsql\nCREATE TABLE users (\n  id UUID PRIMARY KEY,\n  email TEXT NOT NULL,\n  password_hash TEXT NOT NULL,\n  name TEXT NOT NULL,\n  role TEXT NOT NULL, -- learner/creator/reviewer/admin\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE TABLE quizzes (\n  id UUID PRIMARY KEY,\n  category_id UUID NOT NULL,\n  question TEXT NOT NULL,\n  choices JSONB NOT NULL, -- [{id, text}]\n  correct_choice_id TEXT NOT NULL,\n  explanation TEXT NOT NULL,\n  status TEXT NOT NULL DEFAULT 'pending', -- pending/approved/rejected\n  created_by UUID NOT NULL,\n  reviewed_by UUID,\n  floor_plan_zone_id UUID,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE TABLE quiz_answers (\n  id UUID PRIMARY KEY,\n  user_id UUID NOT NULL,\n  quiz_id UUID NOT NULL,\n  session_id UUID NOT NULL,\n  choice_id TEXT NOT NULL,\n  is_correct BOOLEAN NOT NULL,\n  answered_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE TABLE floor_plans (\n  id UUID PRIMARY KEY,\n  image_url TEXT NOT NULL,\n  zones JSONB NOT NULL, -- [{zoneId, label, rect:{x,y,w,h}, type}]\n  created_by UUID NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE TABLE categories (\n  id UUID PRIMARY KEY,\n  name TEXT NOT NULL,\n  description TEXT\n);\n\nCREATE TABLE badges (\n  id UUID PRIMARY KEY,\n  user_id UUID NOT NULL,\n  category_id UUID NOT NULL,\n  earned_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\n\n## Screens (max 4)\n| Screen | Path | Description |\n|--------|------|-------------|\n| ログイン | /login | メール+パスワード認証、ロール別リダイレクト |\n| クイズ画面 | /quiz | カテゴリ選択→4択出題→即時正誤・解説表示→スコア確認 |\n| レビュー画面 | /review | AI生成クイズ一覧の承認/修正/却下操作（reviewer/admin） |\n| ダッシュボード | /dashboard | 全ユーザーのカテゴリ別正答率・弱点・受験回数一覧（admin） |\n\n## Key Test Cases (max 5)\n| Test | Given | When | Then |\n|------|-------|------|------|\n| 承認済みのみ出題 | 承認済み3件・未承認2件がDBにある | GET /api/quizzes?category=X | 承認済み3件のみ返却される |\n| 正答でスコア保存 | 認証済みユーザー、正しいchoiceIdを送信 | POST /api/quizzes/:id/answer | is_correct=true、quiz_answersにレコード挿入される |\n| 満点時バッジ付与 | 10問セッションで全問正解 | セッション終了API呼び出し | badgesテーブルに該当カテゴリのバッジが挿入される |\n| 権限外アクセス拒否 | learnerロールのJWT | PUT /api/quizzes/:id/review | 403レスポンスが返る |\n| カテゴリ0件エラー | 指定カテゴリに承認済み問題が0件 | GET /api/quizzes?category=empty | 空配列+メッセージを返す（200） |\n\n## Implementation Constraints\n- Real DB/API connections only. No mock data, no hardcoded arrays.\n- Backend-first: implement API before UI.\n- Show \"Not implemented\" for unfinished features.\n- All API endpoints must be callable by external services (API-first design).\n- パスワードはbcryptでハッシュ化必須。\n- ファイルアップロードはS3互換ストレージに保存し、DBにはURLのみ保存。\n- AI生成はOpenAI APIへの実接続のみ（モック不可）；障害時は既存クイズ出題は継続。\n- DBスキーマ変更はマイグレーションファイル（db/migrations/）で管理。\n- Docker Composeでapp・db・storageの3サービスを起動可能にする。\n- 楽観的ロック：quizzesテーブルにupdated_atを用いて同時レビュー競合を検出し409を返す。\n",
    "prdMarkdown": "# PRD: https://github.com/o-shina/scrum-guardこれと同じ仕組みで細胞培養の基本やラボルール会社の仕組みを楽しく覚えてテストできる仕組みを作りたい\n\n## 問題定義\nバイオ系ラボにおいて、新人スタッフ（月1人以上入社）への教育がOJT中心で1人あたり1ヶ月以上かかり、口頭伝達による抜け漏れ・属人化が常態化している。特にゾーニング（汚染エリア区分）は暗黙知化しており体系的に教えられない。結果としてコンタミが数ヶ月に1回発生し、先輩社員の教育工数が継続的に浪費されている。scrum-guard のようなクイズ形式の反復学習システムで、細胞培養手順・ラボルール・安全管理を構造化し、新人が自律的に学習・テストできる仕組みを構築する。\n\n## 対象ユーザー\nバイオ系中規模ラボ（10〜30人）の新人スタッフ（入社直後〜3ヶ月目）、教育担当の先輩研究員、クイズ内容をレビューする専門家（研究責任者等）、学習進捗を把握するラボマネージャー\n\n## Jobs to be Done\n1. 新人として：細胞培養手順・ゾーニング・試薬安全管理・報告ルートを、反復クイズで自分のペースで確実に覚えたい\n2. 先輩研究員として：同じ説明を何度も繰り返さず、新人の理解度を客観的に把握して不足箇所だけ補足したい\n3. 専門家として：クイズ内容を10分以内で効率的にレビューし、誤情報の配信を防ぎたい\n4. ラボマネージャーとして：新人ごとの学習進捗とテスト結果を一覧で確認し、OJT期間を短縮したい\n\n## コア機能（MVP）\n### カテゴリ別クイズ出題・回答エンジン\n「細胞培養基本」「ゾーニング」「試薬安全管理」「ラボルール」「報告ルート」等のカテゴリから4択クイズを出題。正誤判定・解説表示・スコア計算をリアルタイムで実施。満点を目指す反復動機づけとしてスコアとバッジを付与する。\n\n**優先度**: must\n\n**受け入れ基準**:\n- DBに登録されたクイズ問題がカテゴリ別にランダム抽出され、ブラウザに表示される\n- 回答送信後、正誤判定と解説がDBから取得・表示される\n- 1セッションのスコア（正答数/出題数）がDBに保存される\n- 満点達成時にバッジがユーザーレコードに付与される\n- データ経路はすべて実DBを使用し、モックデータやハードコード配列は不可\n\n**エッジケース**:\n- カテゴリ内に問題が0件の場合：「このカテゴリにはまだ問題がありません」と表示\n- 回答送信中にネットワーク断：回答をローカルに保持し、復帰後に再送信を試行\n- 同時に同じクイズセッションを複数タブで開いた場合：最後の送信のみを有効とする\n- 不正な回答値（選択肢IDが存在しない等）：サーバー側で検証しエラー返却\n\n### クイズ問題管理・AI生成＋専門家レビュー\n既存マニュアル（PDF/テキスト）をアップロードすると、AIが4択クイズ候補を生成。専門家が差分レビュー画面で承認/修正/却下を行う。承認済み問題のみが出題対象になる。\n\n**優先度**: must\n\n**受け入れ基準**:\n- マニュアルファイル（PDF/TXT）アップロード後、AI APIを呼び出しクイズ候補がDBに保存される\n- レビュー画面で問題文・選択肢・正答・解説が一覧表示され、承認/修正/却下操作ができる\n- 承認ステータスが「承認済」の問題のみが出題エンジンから取得される\n- 10問のレビューが10分以内で完了できるUI（1問あたり60秒以内で判断可能な情報量）\n- データ経路は実DB・実AI API接続であること\n\n**エッジケース**:\n- AI APIがタイムアウトした場合：エラーメッセージ表示＋リトライボタン\n- アップロードファイルが空・不正形式の場合：バリデーションエラーを即時表示\n- AI生成結果が0件の場合：「問題を生成できませんでした。マニュアル内容を確認してください」と表示\n- 複数の専門家が同じ問題を同時にレビューした場合：楽観的ロックで後の更新時に競合通知\n- 却下された問題の再生成要求フロー\n\n### ゾーニング視覚化クイズ\nラボの平面図画像上にエリアをマッピングし、「このエリアで安全キャビネットは必要か？」等のゾーニング判断をクイズ化。暗黙知を視覚的に構造化して出題する。\n\n**優先度**: must\n\n**受け入れ基準**:\n- 管理者がラボ平面図画像をアップロードし、クリックでエリアを矩形指定・ゾーン属性（清潔/準清潔/一般）を付与できる\n- 出題時にエリアがハイライトされ、そのエリアのルールに関する問題が表示される\n- ゾーンデータ・エリア座標・属性はすべてDBに保存される\n- データ経路が実DBであること\n\n**エッジケース**:\n- 平面図がアップロードされていない状態でゾーニングクイズを選択：「平面図が未登録です」と表示\n- エリア定義が0件の場合：出題不可のメッセージ表示\n- 画像ファイルが大きすぎる場合（10MB超）：サイズ制限エラー\n- モバイル端末でのエリア指定操作の精度低下：最小エリアサイズを設定\n\n### 学習進捗ダッシュボード\n新人ごとのカテゴリ別正答率・受験回数・満点達成状況・弱点カテゴリを一覧表示。ラボマネージャーがOJT補足箇所を特定できる。\n\n**優先度**: must\n\n**受け入れ基準**:\n- ユーザー一覧にカテゴリ別正答率・受験回数・最終受験日が表示される\n- 正答率が70%未満のカテゴリが「要注意」としてハイライトされる\n- データはDBのクイズ回答履歴から集計される（リアルタイム）\n- CSV形式でのエクスポートが可能\n- データ経路が実DBであること\n\n**エッジケース**:\n- 受験履歴が0件のユーザー：「未受験」と表示\n- 大量ユーザー（30人）の一覧表示時のページネーション\n- 権限のないユーザーがダッシュボードにアクセス：403エラー表示\n\n### ユーザー・ロール管理\n新人（学習者）、先輩研究員（問題作成者）、専門家（レビュアー）、ラボマネージャー（管理者）のロールを管理。ロールに応じた画面・機能アクセス制御。\n\n**優先度**: must\n\n**受け入れ基準**:\n- 管理者がユーザーを登録し、4種のロール（learner/creator/reviewer/admin）を付与できる\n- ロールに応じてアクセス可能な画面・APIが制限される\n- 認証はメールアドレス＋パスワードで実施、セッション管理はサーバーサイド\n- ユーザーデータは実DBに保存されること\n\n**エッジケース**:\n- 管理者が自分自身のロールを削除しようとした場合：操作を禁止\n- 存在しないメールアドレスでログイン試行：「メールアドレスまたはパスワードが違います」と表示（情報漏洩防止）\n- 同一メールアドレスでの重複登録：一意制約エラー表示\n- パスワードが8文字未満の場合：バリデーションエラー\n\n## Non-Goals（やらないこと）\n- 複数ラボ間の統合管理・マルチテナント対応（現時点では単一ラボ対象）\n- OJT自体の廃止（対面教育の補完であり代替ではない）\n- 動画教材の作成・配信機能\n- スマートフォンネイティブアプリの開発（Webブラウザ対応のみ）\n- 教育コストの自動金額換算・ROI算出ダッシュボード\n\n## ユーザーフロー\n### 新人のクイズ学習フロー\n1. ログイン\n2. カテゴリ一覧から学習したいカテゴリを選択\n3. クイズ開始（10問1セット）\n4. 各問題に回答し、即時に正誤・解説を確認\n5. セッション終了後にスコアとバッジを確認\n6. 弱点カテゴリを再受験\n\n### AI問題生成＋専門家レビューフロー\n1. 先輩研究員がマニュアルPDFをアップロード\n2. カテゴリとAI生成問題数を指定して生成実行\n3. AI生成されたクイズ候補一覧が表示される\n4. 専門家がレビュー画面で各問題を承認/修正/却下\n5. 承認された問題が出題プールに追加される\n\n### ラボマネージャーの進捗確認フロー\n1. ログイン\n2. ダッシュボードでユーザー一覧と進捗を確認\n3. 要注意カテゴリのある新人を特定\n4. 該当新人の詳細画面で回答履歴を確認\n5. 必要に応じてOJT補足指示を行う\n\n## 非機能要件（ISO/IEC 25010）\n### 機能適合性\nクイズ出題・回答・スコア計算・レビューワークフローが仕様通りに動作する\n- 全カテゴリのクイズ出題→回答→スコア保存→解説表示のパスが正常完了する\n- 承認済み問題のみが出題され、未承認・却下問題は出題されない\n- 正答率計算が回答履歴と一致する（誤差0%）\n\n### 性能効率性\n30人規模のラボで快適に動作する性能\n- クイズ出題APIの応答は95パーセンタイルで1秒以内\n- ダッシュボードの集計表示は30ユーザー分で3秒以内\n- AI問題生成は10問あたり60秒以内にレスポンスを返す\n- 同時接続10ユーザーで性能劣化なし\n\n### 互換性\nラボ環境で使用される主要ブラウザで動作する\n- Chrome/Safari/Firefox/Edgeの最新版で全機能が動作する\n- REST APIはJSON形式で外部システムと連携可能\n- 画面解像度1280x720以上で表示崩れなし\n\n### 使用性\nITリテラシーが高くないラボスタッフが説明なしで操作できる\n- 初回ユーザーがログインからクイズ完了まで説明なしで5分以内に完了できる\n- レビュー画面で1問の承認/却下操作が3クリック以内で完了する\n- エラー発生時にユーザーが次のアクションを理解できるメッセージを表示する\n- 色覚多様性に配慮し、正誤表示を色だけでなくアイコン・テキストでも区別する\n\n### 信頼性\n業務時間中に安定して利用可能\n- 月間稼働率99.5%以上\n- DB障害時にクイズ回答データが消失しない（トランザクション管理）\n- AI API障害時でもクイズ出題機能（既存問題）は継続動作する\n\n### セキュリティ\nラボの業務情報・マニュアル内容を保護する\n- 全入力値はサーバーサイドでバリデーション実施\n- パスワードはbcrypt以上の強度でハッシュ化して保存\n- ロールベースアクセス制御により権限外の操作をAPI・UI両方で遮断\n- アップロードされたマニュアルファイルは認証済みユーザーのみアクセス可能\n- 全操作ログ（ログイン・レビュー承認等）をDB記録し否認防止を担保\n\n### 保守性\n小規模チームで継続的に保守・拡張できる\n- 主要モジュール（クイズエンジン・レビュー・ダッシュボード）のユニットテストカバレッジ80%以上\n- API層とビジネスロジック層が分離されている\n- DB スキーマ変更はマイグレーションファイルで管理\n\n### 移植性\n別ラボへの展開時に容易にセットアップできる\n- Docker Composeで全サービス（アプリ・DB・AIプロキシ）を起動可能\n- 環境変数で外部API キー・DB接続先を切り替え可能\n- 初期セットアップ手順がREADMEに記載され、30分以内に完了可能\n\n## 計測指標\n| 指標 | 定義 | 目標 |\n|------|------|------|\n| 新人の平均OJT期間 | 入社日からラボマネージャーが「独り立ち」認定した日までの日数の平均 | 導入前比で30%短縮（例：30日→21日） |\n| カテゴリ別正答率の推移 | 各新人の初回受験時正答率と3回目受験時正答率の差分 | 3回目受験時に全カテゴリ平均正答率80%以上 |\n| 先輩の教育工数 | 先輩研究員が新人教育に費やした時間（自己申告/週次） | 導入前比で50%削減 |\n| コンタミ発生頻度 | コンタミネーション報告件数/月 | 導入後6ヶ月で発生間隔が2倍に延伸 |\n| クイズ問題レビュー効率 | 専門家が10問のレビューに要する時間 | 10分以内 |\n\n## 実装制約\n\nこの PRD を実装する際、以下のルールを必ず遵守すること。\n\n- モックデータ、ハードコードされた配列、スタブ API での実装は完了とみなさない\n- すべてのデータは実際の DB/API から取得・保存すること。「見た目が動く」だけでは受け入れ基準を満たさない\n- バックエンド API が未実装の場合、UI より先にバックエンドの最小実装（仮でも本物の I/O）を作ること\n- 未実装の機能は UI 上で明示的に「未実装」と表示し、モックで補完してはならない\n"
  }
}